---
title: "index"
author: "Julien BARRERE"
date: "5 octobre 2021"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

This R Markdown aims at testing the functioning of the `targets` package to produce R Markdown documents. 

# Packages and set up

We start by loading the required packages. `targets` must be version 0.5.0.9000 or above. 

```{r, eval = FALSE}
require(c("dplyr", "ggplot2", "targets", "tidyr", 
                            "RColorBrewer", "lme4", "data.table", 
                            "knitr", "stringr", "measurements", "sf"))
```

Second, we call the `targets` library. The `tar_unscript()` R function removes the `_targets_r` directory previously written by non-interactive runs of the report. It prevents the pipeline from containing superfluous targets.

```{r}
library(targets)
tar_unscript()
```

# Globals

We define some global options/functions common to all targets, and load the functions located in the R directory of the repository. 

```{targets example-globals, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)
source("R/functions_data.R")
tar_option_set(packages = c("dplyr", "ggplot2", "targets", "tidyr", 
                            "RColorBrewer", "lme4", "data.table", 
                            "knitr", "stringr", "measurements", "sf"))
```

# Targets

## Data importation

### NFI data

We start by importing the following data on: 

- NFI plots (`NFI_plot`) and associated ecological data (`NFI_ecological_data`)
- NFI individual trees that were either alive (`NFI_tree_alive`) or dead (`NFI_tree_dead`) 
- NFI plots remeasured (`NFI_plot_remeasure`) 
- Individual trees remeasured that were either alive  (`NFI_tree_alive_remeasure`) or dead (`NFI_tree_dead_remeasure`) at first measurement. 

```{targets import-NFI-data}
list(
  tar_target(NFI_plot, read_plot(path = "data/FrenchNFI")), 
  tar_target(NFI_ecological_data, read_ecological_data(path = "data/FrenchNFI")),
  tar_target(NFI_tree_alive, read_tree(path = "data/FrenchNFI")), 
  tar_target(NFI_tree_dead, read_dead_tree(path = "data/FrenchNFI")), 
  tar_target(NFI_plot_remeasure, read_reameasure_plot(path = "data/FrenchNFI_remeasure")), 
  tar_target(NFI_tree_alive_remeasure, read.csv("data/donnees_arbres_retour/foret_c135.csv", sep = ";")), 
  tar_target(NFI_tree_dead_remeasure, read.csv("data/donnees_arbres_retour/foret_morts.csv", sep = ";"))
)

```

Second, we merge : 

* the data on alive and dead trees to obtain `NFI_tree`
* the remeasures of previously alive and dead trees to obtain `NFI_tree_remeasured`.

```{targets NFI_tree_join}
list(
  tar_target(NFI_tree, merge_dead_alive(NFI_tree_alive, NFI_tree_dead)),
  tar_target(NFI_tree_remeasured, 
             merge_NFI_remeasured(NFI_tree_alive_remeasure, NFI_tree_dead_remeasure))
)
```

## Data formating - TreeMort project

### Species data

We start by importing :

* The existing species table in the NFI directory (`NFI_species`).
* A correspondence table linking genus and families. This table was built from the NCBI Taxonomy database ([Federhen 2012](https://doi.org/10.1093/nar/gkr1178)).

```{targets import-species-NFI}
list(
  tar_target(NFI_species, read.csv("data/FrenchNFI/species.csv", sep = ",")), 
  tar_target(NFI_genus_species_correspondence, read.csv("data/TreeMort/correspondanceGenusFamilyNFI.csv", sep = ";"))
)
```

Using these two tables, we create a species table that matches TreeMort template (`TreeMort_species`), and write this table in the TreeMort directory. 

```{targets format-species-NFI-to-TreeMort}
tar_target(TreeMort_species, Format_species_TreeMort(NFI_species, NFI_genus_species_correspondence))
```

```{r}
write.table(tar_read(TreeMort_species), 
          file = "data/TreeMort/spp_data.csv", row.names = F)
```



### Trees data

We start by formatting the table of the first (census 1) and second (census 2) measurements (both dead and alive trees).

```{targets format-trees-NFI-to-TreeMort-by-census}
list(
  tar_target(TreeMort_tree_census1, Format_trees_census1_TreeMort(NFI_tree, TreeMort_species)),
  tar_target(TreeMort_tree_census2, Format_trees_census2_TreeMort(NFI_tree_remeasured, TreeMort_tree_census1))
)
```

We merge these two dataframes to obtain the complete tree NFI dataset formatted for TreeMort (`TreeMort_tree`), that we write in the TreeMort directory. 

```{targets format-trees-NFI-to-TreeMort}
tar_target(TreeMort_tree, 
           rbind(subset(TreeMort_tree_census1, 
                        plot.id %in% TreeMort_tree_census2$plot.id),
                 TreeMort_tree_census2))
```

```{r}
write.table(tar_read(TreeMort_tree), 
          file = "data/TreeMort/tree_data.csv", row.names = F)
```

### Plots data

We format the `NFI_plot` table to fit into TreeMort template, and we write the formated table (`TreeMort_plot`) in the TreeMort directory.

```{targets format-plots-NFI-to-TreeMort}
tar_target(TreeMort_plot, Format_plots_TreeMort(NFI_plot, NFI_ecological_data))
```

```{r}
write.table(tar_read(TreeMort_plot), 
          file = "data/TreeMort/plot_data.csv", row.names = F)
```


# Pipeline

If you ran all the `{targets}` chunks in non-interactive mode, then your R scripts are set up to run the pipeline.

```{r}
tar_make()
```

# Output

The `targets` dependency graph helps understanding the steps of the pipeline at a high level.

```{r}
tar_visnetwork()
```


