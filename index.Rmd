---
title: "index"
author: "Julien BARRERE"
date: "5 octobre 2021"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

# Packages and set up

We start by loading the required packages. `targets` must be version 0.5.0.9000 or above. 

```{r, eval = FALSE}
require(c("dplyr", "ggplot2", "targets", "tidyr", "RColorBrewer", "lme4",
          "data.table", "knitr", "stringr", "measurements", "sf", "raster",
          "rgdal", "exactextractr", "rgeos", "rnaturalearth", "rnaturalearthdata", 
          "ggspatial", "cowplot"))
```

Second, we call the `targets` library. The `tar_unscript()` R function removes the `_targets_r` directory previously written by non-interactive runs of the report. It prevents the pipeline from containing superfluous targets.

```{r}
library(targets)
tar_unscript()
```

# Globals

We define some global options/functions common to all targets, and load the functions located in the R directory of the repository. 

```{targets example-globals, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)
source("R/functions_data.R")
source("R/functions_plot.R")
source("R/FUNDIV/FUNDIV_Data.R")
tar_option_set(packages = c("dplyr", "ggplot2", "targets", "tidyr",
                            "RColorBrewer", "lme4","data.table", "knitr",
                            "stringr", "measurements", "sf", "raster",
                            "rgdal", "exactextractr", "rgeos", "rnaturalearth",
                            "rnaturalearthdata", "ggspatial", "cowplot"))
```


# Importation of french NFI data

We start by importing the following data on: 

- NFI plots (`NFI_plot`) and associated ecological data (`NFI_ecological_data`) and elevation (`NFI_plot_elevation`)
- NFI individual trees that were either alive (`NFI_tree_alive`) or dead (`NFI_tree_dead`) 
- NFI plots remeasured (`NFI_plot_remeasure`) 
- Individual trees remeasured that were either alive  (`NFI_tree_alive_remeasure`) or dead (`NFI_tree_dead_remeasure`) at first measurement. 

```{targets import-NFI-data}
list(
  tar_target(NFI_plot, read_plot(path = "data/FrenchNFI")), 
  tar_target(NFI_plot_elevation, read.csv("data/elevation_NFIplots.csv", sep = ";")),
  tar_target(NFI_ecological_data, read_ecological_data(path = "data/FrenchNFI")),
  tar_target(NFI_tree_alive, read_tree(path = "data/FrenchNFI")), 
  tar_target(NFI_tree_dead, read_dead_tree(path = "data/FrenchNFI")), 
  tar_target(NFI_plot_remeasure, read_reameasure_plot(path = "data/FrenchNFI_remeasure")), 
  tar_target(NFI_tree_alive_remeasure, read.csv("data/donnees_arbres_retour/foret_c135.csv", sep = ";")), 
  tar_target(NFI_tree_dead_remeasure, read.csv("data/donnees_arbres_retour/foret_morts.csv", sep = ";"))
)

```

Second, we merge : 

* the data on alive and dead trees to obtain `NFI_tree`
* the remeasures of previously alive and dead trees to obtain `NFI_tree_remeasured`.

```{targets NFI_tree_join}
list(
  tar_target(NFI_tree, merge_dead_alive(NFI_tree_alive, NFI_tree_dead)),
  tar_target(NFI_tree_remeasured, 
             merge_NFI_remeasured(NFI_tree_alive_remeasure, NFI_tree_dead_remeasure))
)
```


# Formating of French NFI data for the TreeMort project

## Species data

We start by importing :

* The existing species table in the NFI directory (`NFI_species`).
* A correspondence table linking genus and families. This table was built from the NCBI Taxonomy database ([Federhen 2012](https://doi.org/10.1093/nar/gkr1178)).

```{targets import-species-NFI}
list(
  tar_target(NFI_species, read.csv("data/FrenchNFI/species.csv", sep = ",")), 
  tar_target(NFI_genus_species_correspondence, read.csv("data/TreeMort/correspondanceGenusFamilyNFI.csv", sep = ";"))
)
```

Using these two tables, we create a species table that matches TreeMort template (`TreeMort_species`), and write this table in the TreeMort directory. 

```{targets format-species-NFI-to-TreeMort}
tar_target(TreeMort_species, Format_species_TreeMort(NFI_species, NFI_genus_species_correspondence))
```

```{r}
write.table(tar_read(TreeMort_species), 
          file = "data/TreeMort/spp_data.csv", row.names = F)
```



## Trees data

We start by formatting the table of the first (census 1) and second (census 2) measurements (both dead and alive trees).

```{targets format-trees-NFI-to-TreeMort-by-census}
list(
  tar_target(TreeMort_tree_census1, Format_trees_census1_TreeMort(NFI_tree, TreeMort_species)),
  tar_target(TreeMort_tree_census2, Format_trees_census2_TreeMort(NFI_tree_remeasured, TreeMort_tree_census1))
)
```

We merge these two dataframes to obtain the complete tree NFI dataset formatted for TreeMort (`TreeMort_tree`), that we write in the TreeMort directory. 

```{targets format-trees-NFI-to-TreeMort}
tar_target(TreeMort_tree, 
           rbind(subset(TreeMort_tree_census1, 
                        tree.id %in% TreeMort_tree_census2$tree.id),
                 TreeMort_tree_census2))
```

```{r}
write.table(tar_read(TreeMort_tree), 
          file = "data/TreeMort/tree_data.csv", row.names = F)
```

## Plots data

We format the `NFI_plot` table to fit into TreeMort template, and we write the formated table (`TreeMort_plot`) in the TreeMort directory.

```{targets format-plots-NFI-to-TreeMort}
list(
  tar_target(NFI_stand_age, Compute_NFI_stand_age(NFI_tree)), 
  tar_target(TreeMort_plot, Format_plots_TreeMort(NFI_plot, NFI_ecological_data, NFI_plot_elevation, NFI_stand_age))
)
```

```{r}
write.table(tar_read(TreeMort_plot), 
          file = "data/TreeMort/plot_data.csv", row.names = F)
```

## Census data

First, we need to create a management variable describing the occurence of a cut in the last 5 years for each census. 

```{targets create-management-census}
tar_target(NFI_census_management, compute_management_census(NFI_plot, NFI_plot_remeasure))
```

We format the `TreeMort_tree` table to create a census table fitting TreeMort template, and we write the formated table (`TreeMort_census`) in the TreeMort directory.

```{targets format-census-TreeMort}
tar_target(TreeMort_census, Format_census_TreeMort(TreeMort_tree, NFI_census_management))
```

```{r}
write.table(tar_read(TreeMort_census), 
          file = "data/TreeMort/census_data.csv", row.names = F)
```

## Meta data

We write a metadata table in the TreeMort directory to specify important information on some columns. 

```{targets metadata-TreeMort}
tar_target(TreeMort_metadata, Meta_data_TreeMort())
```

```{r}
write.table(tar_read(TreeMort_metadata), 
          file = "data/TreeMort/meta_data.csv", row.names = F)
```

# Importation and formating of FUNDIV data

## Importation

We start by importing the tree (`FUNDIV_tree_original`) and plot (`FUNDIV_plot`) datatables of FUNDIV. 
```{targets import-FUNDIV}
list(
  tar_target(FUNDIV_tree_original, read_FUNDIV_tree_data(data_path = "data/FUNDIV", remove_harv = TRUE)), 
  tar_target(FUNDIV_plot, read_FUNDIV_plot_data(data_path = "data/FUNDIV"))
)
```

## Inclusion of French NFI remeasured data

Using `FUNDIV_plot` dataset, we can format the NFI trees that were measured twice to FUNDIV template. 
```{targets format-trees-TreeMort-to-FUNDIV}
tar_target(FUNDIV_FrenchNFI_tree, 
           Format_trees_TreeMort_to_FUNDIV(TreeMort_tree, TreeMort_plot, FUNDIV_plot))
```

Lastly, we can replace the French data in the original FUNDIV tree dataset by the newly formatted `FUNDIV_FrenchNFI_tree`. 

```{targets replace-FrenchNFI-FUNDIV}
tar_target(FUNDIV_tree, 
           (FUNDIV_tree_original %>% 
             filter(country != "FR") %>% 
             rbind(FUNDIV_FrenchNFI_tree)))
```


## Formating to Finnish NFI template

The Finnish NFI template is slightly different from the French NFI template or FUNDIV template. Therefore, we need to format them. 

```{targets format-FUNDIV-to-FinnishNFI}
tar_target(FinnishNFI_French_tree, 
           Format_trees_FUNDIV_to_FinnishNFI(FUNDIV_FrenchNFI_tree, NFI_tree, 
                                              NFI_plot_elevation, NFI_plot_remeasure, 
                                              NFI_ecological_data))
```

```{r}
write.table(tar_read(FinnishNFI_French_tree), 
          file = "data/FinnishNFI/FinnishNFI_French_tree.csv", row.names = F)
```

We write a metadata table in the FinnishNFI directory to specify important information on some columns. 

```{targets metadata-FinnishNFI}
tar_target(FinnishNFI_metadata, Meta_data_FinnishNFI())
```

```{r}
write.table(tar_read(TreeMort_metadata), 
          file = "data/FinnishNFI/FinnishNFI_meta_data.csv", row.names = F)
```


## Inclusion of disturbance data in FUNDIV

We create a circular buffer around each FUNDIV plot center, and we associate each plot to the percentage of the buffer area covered by each type of disturbance ([Senf & Seidl, 2021a](https://doi.org/10.1111/gcb.15679)) that occured between 1986 and 2020. We use three size of circular buffer: 15m, 100m and 200m: 

```{targets import-disturbance-Senf-areaPercentage}
list(tar_target(disturbance_per_plot_15m, 
           Get_disturbance_per_plot(15, FUNDIV_tree, "data/Disturbance")), 
     tar_target(disturbance_per_plot_100m, 
           Get_disturbance_per_plot(100, FUNDIV_tree, "data/Disturbance")), 
     tar_target(disturbance_per_plot_200m, 
           Get_disturbance_per_plot(200, FUNDIV_tree, "data/Disturbance")))
```

Secondly, we add this information in the FUNDIV database.

```{targets add-Senf-areaPercentage-to-FUNDIV}
list(tar_target(FUNDIV_tree_disturbance15m, 
           add_disturbance_to_FUNDIV(FUNDIV_tree, disturbance_per_plot_15m)), 
     tar_target(FUNDIV_tree_disturbance100m, 
           add_disturbance_to_FUNDIV(FUNDIV_tree, disturbance_per_plot_100m)), 
     tar_target(FUNDIV_tree_disturbance200m, 
           add_disturbance_to_FUNDIV(FUNDIV_tree, disturbance_per_plot_200m)))
```

The code below extracts the prevalence (% of buffer area of all plots covered) of each disturbance type per country and per year, in order to monitor temporal variations in disturbance regimes. 

```{targets get-disturbance-prevalence-per-country-and-year}
tar_target(prevalence_per_country_per_year, 
           get_annualPrevalence(disturbance_per_plot_200m, FUNDIV_tree))
```


Extraction of Agreste data on annual salvage logging volume in France (national level) from 2009 to 2019. 

```{targets get-agreste-data}
tar_target(data_agreste, import_agreste("data/Agreste/agreste_total.csv"))
```


# Make all plots and run pipeline

```{targets make-all-plots}
list(
  tar_target(Map_areaCoveredPerDisturbance_FUNDIVplots, 
           Map_FUNDIVplots_areaCoveredPerDisturbance(FUNDIV_tree_disturbance100m)), 
  tar_target(plot_Compare_NFI_Senf_disturbance_area, 
           Compare_NFI_Senf_disturbance_area(FUNDIV_tree_disturbance100m, NFI_plot_remeasure)), 
  tar_target(plot_prevalence_per_country_per_year, 
           plot_annualPrevalence(prevalence_per_country_per_year)), 
  tar_target(plot_disturbedArea_perMortalityRate_15m, 
           plot_areaDisturbance_perMortalityRate(FUNDIV_tree_disturbance15m, 
                                                 "Buffer = 15m radius", 
                                                 death.in = "natural mortality")), 
  tar_target(plot_disturbedArea_perMortalityRate_100m, 
           plot_areaDisturbance_perMortalityRate(FUNDIV_tree_disturbance100m, 
                                                 "Buffer = 100m radius", 
                                                 death.in = "natural mortality")), 
  tar_target(plot_disturbedArea_perMortalityRate_200m, 
           plot_areaDisturbance_perMortalityRate(FUNDIV_tree_disturbance200m, 
                                                 "Buffer = 200m radius", 
                                                 death.in = "natural mortality")), 
  tar_target(plot_disturbedArea_perMortalityRate_200m_harvest, 
           plot_areaDisturbance_perMortalityRate(FUNDIV_tree_disturbance200m, 
                                                 "Buffer = 200m radius", 
                                                 death.in = "harvested")), 
  tar_target(plot_disturbedArea_perMortalityRate_200m_unknown, 
           plot_areaDisturbance_perMortalityRate(FUNDIV_tree_disturbance200m, 
                                                 "Buffer = 200m radius", 
                                                 death.in = "unknown cause")), 
  tar_target(plot_disturbedArea_perMortalityRate_200m_alldeath, 
           plot_areaDisturbance_perMortalityRate(FUNDIV_tree_disturbance200m, 
                                                 "Buffer = 200m radius", 
                                                 death.in = c("natural mortality", "harvested", "unknown cause"))), 
  tar_target(plot_agreste_against_disturbance, 
             plot_agreste_disturbance(prevalence_per_country_per_year, data_agreste))
  
)
```

```{r, message=FALSE, results='hide'}
tar_make()
```


# Data exploration - Disturbance data and FUNDIV

We plot the percentage of the buffer around each plot covered by the three types of disturbance. 
```{r figAreaCoveredPerDisturbance, fig.height=3, fig.width=10, fig.align='center'}
tar_read(Map_areaCoveredPerDisturbance_FUNDIVplots)
ggplot2::ggsave(tar_read(Map_areaCoveredPerDisturbance_FUNDIVplots), 
       filename = "plots/Map_areaCoveredPerDisturbance_FUNDIVplots.jpg", 
       height = 9, width = 30, unit = 'cm', dpi = 600)  
```


When focusing on france, we can compare the area covered by each disturance to the estimations of disturbance nature and intensity made by NFI agents. 

```{r plot_Compare_NFI_Senf_disturbance_area, fig.height=3, fig.width=10, fig.align='center'}
tar_read(plot_Compare_NFI_Senf_disturbance_area)
ggplot2::ggsave(tar_read(plot_Compare_NFI_Senf_disturbance_area), 
       filename = "plots/plot_Compare_NFI_Senf_disturbance_area.pdf", 
       height = 9, width = 30, unit = 'cm')  
```

In the plot below, we compute from the dataset `disturbance_per_plot_200m` the percentage of the buffer area affected by each disturbance for each year and each country, and show this temporal and spatial variability. We also added the year of first and last measurement for each country (vertical dotted black lines). 

```{r save-plot-prevalence-per-country-per-year, fig.height=5, fig.width=10, fig.align='center'}
tar_read(plot_prevalence_per_country_per_year)
ggplot2::ggsave(tar_read(plot_prevalence_per_country_per_year), 
       filename = "plots/plot_prevalence_per_country_per_year.pdf", 
       height = 15, width = 30, unit = 'cm')  
```

Using Agreste data, we have access to the annual volume of salvage logging in France from 2009 to 2019. The plot below compares this volume of salvage logging with annual prevalence for the same period. 

```{r save-plot-prevalence-against-agreste, fig.height=7, fig.width=7, fig.align='center'}
tar_read(plot_agreste_against_disturbance)
ggplot2::ggsave(tar_read(plot_agreste_against_disturbance), 
       filename = "plots/plot_agreste_against_disturbance.pdf", 
       height = 15, width = 15, unit = 'cm')  
```


To make the plots below, we computed the mortality rate of each plot (harvested trees and recruits were removed), converted it into a qualitative variable and we computed for each class the percentage of area covered by each type of disturbance. We make one plot per buffer size.  

```{r save-plot-disturbedArea-perMortalityRate-15m, fig.height=6, fig.width=10, fig.align='center'}
tar_read(plot_disturbedArea_perMortalityRate_15m)
ggplot2::ggsave(tar_read(plot_disturbedArea_perMortalityRate_15m), 
       filename = "plots/plot_disturbedArea_perMortalityRate_15m.pdf", 
       height = 12, width = 20, unit = 'cm')  
```

```{r save-plot-disturbedArea-perMortalityRate-100m, fig.height=6, fig.width=10, fig.align='center'}
tar_read(plot_disturbedArea_perMortalityRate_100m)
ggplot2::ggsave(tar_read(plot_disturbedArea_perMortalityRate_100m), 
       filename = "plots/plot_disturbedArea_perMortalityRate_100m.pdf", 
       height = 12, width = 20, unit = 'cm')  
```

```{r save-plot-disturbedArea-perMortalityRate-200m, fig.height=6, fig.width=10, fig.align='center'}
tar_read(plot_disturbedArea_perMortalityRate_200m)
ggplot2::ggsave(tar_read(plot_disturbedArea_perMortalityRate_200m), 
       filename = "plots/plot_disturbedArea_perMortalityRate_200m.pdf", 
       height = 12, width = 20, unit = 'cm')  
```

In the 3 plots above, we only considered natural mortality when calculating mortality rates (harvested trees, or trees that died of unknown causes were removed from the dataset). In the three plots below, we show the same figure than above (with 200m-radius buffer), but with different approaches to calculate the mortality rates (with harvest only, unknown cause only, or all cause of death confounded)

```{r save-plot-disturbedArea-perMortalityRate-200m-harvest, fig.height=6, fig.width=10, fig.align='center'}
tar_read(plot_disturbedArea_perMortalityRate_200m_harvest)
ggplot2::ggsave(tar_read(plot_disturbedArea_perMortalityRate_200m_harvest), 
       filename = "plots/plot_disturbedArea_perMortalityRate_200m_harvest.pdf", 
       height = 12, width = 20, unit = 'cm')  
```

```{r save-plot-disturbedArea-perMortalityRate-200m-unknown, fig.height=6, fig.width=10, fig.align='center'}
tar_read(plot_disturbedArea_perMortalityRate_200m_unknown)
ggplot2::ggsave(tar_read(plot_disturbedArea_perMortalityRate_200m_unknown), 
       filename = "plots/plot_disturbedArea_perMortalityRate_200m_unknown.pdf", 
       height = 12, width = 20, unit = 'cm')  
```

```{r save-plot-disturbedArea-perMortalityRate-200m-alldeath, fig.height=6, fig.width=10, fig.align='center'}
tar_read(plot_disturbedArea_perMortalityRate_200m_alldeath)
ggplot2::ggsave(tar_read(plot_disturbedArea_perMortalityRate_200m_alldeath), 
       filename = "plots/plot_disturbedArea_perMortalityRate_200m_alldeath.pdf", 
       height = 12, width = 20, unit = 'cm')  
```




