---
title: "index"
author: "Julien BARRERE"
date: "5 octobre 2021"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

# Packages and set up

We start by loading the required packages. `targets` must be version 0.5.0.9000 or above. 

```{r, eval = FALSE}
require(c("dplyr", "ggplot2", "targets", "tidyr", "RColorBrewer", "lme4",
          "data.table", "knitr", "stringr", "measurements", "sf", "raster",
          "rgdal", "exactextractr", "rgeos", "rnaturalearth", "rnaturalearthdata", 
          "ggspatial"))
```

Second, we call the `targets` library. The `tar_unscript()` R function removes the `_targets_r` directory previously written by non-interactive runs of the report. It prevents the pipeline from containing superfluous targets.

```{r}
library(targets)
tar_unscript()
```

# Globals

We define some global options/functions common to all targets, and load the functions located in the R directory of the repository. 

```{targets example-globals, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)
source("R/functions_data.R")
source("R/functions_plot.R")
source("R/FUNDIV/FUNDIV_Data.R")
tar_option_set(packages = c("dplyr", "ggplot2", "targets", "tidyr",
                            "RColorBrewer", "lme4","data.table", "knitr",
                            "stringr", "measurements", "sf", "raster",
                            "rgdal", "exactextractr", "rgeos", "rnaturalearth",
                            "rnaturalearthdata", "ggspatial"))
```

# Targets

## Data importation

### NFI data

We start by importing the following data on: 

- NFI plots (`NFI_plot`) and associated ecological data (`NFI_ecological_data`) and elevation (`NFI_plot_elevation`)
- NFI individual trees that were either alive (`NFI_tree_alive`) or dead (`NFI_tree_dead`) 
- NFI plots remeasured (`NFI_plot_remeasure`) 
- Individual trees remeasured that were either alive  (`NFI_tree_alive_remeasure`) or dead (`NFI_tree_dead_remeasure`) at first measurement. 

```{targets import-NFI-data}
list(
  tar_target(NFI_plot, read_plot(path = "data/FrenchNFI")), 
  tar_target(NFI_plot_elevation, read.csv("data/elevation_NFIplots.csv", sep = ";")),
  tar_target(NFI_ecological_data, read_ecological_data(path = "data/FrenchNFI")),
  tar_target(NFI_tree_alive, read_tree(path = "data/FrenchNFI")), 
  tar_target(NFI_tree_dead, read_dead_tree(path = "data/FrenchNFI")), 
  tar_target(NFI_plot_remeasure, read_reameasure_plot(path = "data/FrenchNFI_remeasure")), 
  tar_target(NFI_tree_alive_remeasure, read.csv("data/donnees_arbres_retour/foret_c135.csv", sep = ";")), 
  tar_target(NFI_tree_dead_remeasure, read.csv("data/donnees_arbres_retour/foret_morts.csv", sep = ";"))
)

```

Second, we merge : 

* the data on alive and dead trees to obtain `NFI_tree`
* the remeasures of previously alive and dead trees to obtain `NFI_tree_remeasured`.

```{targets NFI_tree_join}
list(
  tar_target(NFI_tree, merge_dead_alive(NFI_tree_alive, NFI_tree_dead)),
  tar_target(NFI_tree_remeasured, 
             merge_NFI_remeasured(NFI_tree_alive_remeasure, NFI_tree_dead_remeasure))
)
```


## Data formating - TreeMort project

### Species data

We start by importing :

* The existing species table in the NFI directory (`NFI_species`).
* A correspondence table linking genus and families. This table was built from the NCBI Taxonomy database ([Federhen 2012](https://doi.org/10.1093/nar/gkr1178)).

```{targets import-species-NFI}
list(
  tar_target(NFI_species, read.csv("data/FrenchNFI/species.csv", sep = ",")), 
  tar_target(NFI_genus_species_correspondence, read.csv("data/TreeMort/correspondanceGenusFamilyNFI.csv", sep = ";"))
)
```

Using these two tables, we create a species table that matches TreeMort template (`TreeMort_species`), and write this table in the TreeMort directory. 

```{targets format-species-NFI-to-TreeMort}
tar_target(TreeMort_species, Format_species_TreeMort(NFI_species, NFI_genus_species_correspondence))
```

```{r}
write.table(tar_read(TreeMort_species), 
          file = "data/TreeMort/spp_data.csv", row.names = F)
```



### Trees data

We start by formatting the table of the first (census 1) and second (census 2) measurements (both dead and alive trees).

```{targets format-trees-NFI-to-TreeMort-by-census}
list(
  tar_target(TreeMort_tree_census1, Format_trees_census1_TreeMort(NFI_tree, TreeMort_species)),
  tar_target(TreeMort_tree_census2, Format_trees_census2_TreeMort(NFI_tree_remeasured, TreeMort_tree_census1))
)
```

We merge these two dataframes to obtain the complete tree NFI dataset formatted for TreeMort (`TreeMort_tree`), that we write in the TreeMort directory. 

```{targets format-trees-NFI-to-TreeMort}
tar_target(TreeMort_tree, 
           rbind(subset(TreeMort_tree_census1, 
                        tree.id %in% TreeMort_tree_census2$tree.id),
                 TreeMort_tree_census2))
```

```{r}
write.table(tar_read(TreeMort_tree), 
          file = "data/TreeMort/tree_data.csv", row.names = F)
```

### Plots data

We format the `NFI_plot` table to fit into TreeMort template, and we write the formated table (`TreeMort_plot`) in the TreeMort directory.

```{targets format-plots-NFI-to-TreeMort}
list(
  tar_target(NFI_stand_age, Compute_NFI_stand_age(NFI_tree)), 
  tar_target(TreeMort_plot, Format_plots_TreeMort(NFI_plot, NFI_ecological_data, NFI_plot_elevation, NFI_stand_age))
)
```

```{r}
write.table(tar_read(TreeMort_plot), 
          file = "data/TreeMort/plot_data.csv", row.names = F)
```

### Census data

First, we need to create a management variable describing the occurence of a cut in the last 5 years for each census. 

```{targets create-management-census}
tar_target(NFI_census_management, compute_management_census(NFI_plot, NFI_plot_remeasure))
```

We format the `TreeMort_tree` table to create a census table fitting TreeMort template, and we write the formated table (`TreeMort_census`) in the TreeMort directory.

```{targets format-census-TreeMort}
tar_target(TreeMort_census, Format_census_TreeMort(TreeMort_tree, NFI_census_management))
```

```{r}
write.table(tar_read(TreeMort_census), 
          file = "data/TreeMort/census_data.csv", row.names = F)
```

### Meta data

We write a metadata table in the TreeMort directory to specify important information on some columns. 

```{targets metadata-TreeMort}
tar_target(TreeMort_metadata, Meta_data_TreeMort())
```

```{r}
write.table(tar_read(TreeMort_metadata), 
          file = "data/TreeMort/meta_data.csv", row.names = F)
```

## FUNDIV dataset

### Include NFI remeasured data in FUNDIV dataset

We start by importing the tree (`FUNDIV_tree_original`) and plot (`FUNDIV_plot`) datatables of FUNDIV. 
```{targets import-FUNDIV}
list(
  tar_target(FUNDIV_tree_original, read_FUNDIV_tree_data(data_path = "data/FUNDIV", remove_harv = TRUE)), 
  tar_target(FUNDIV_plot, read_FUNDIV_plot_data(data_path = "data/FUNDIV"))
)
```


Using `FUNDIV_plot` dataset, we can format the NFI trees that were measured twice to FUNDIV template. 
```{targets format-trees-TreeMort-to-FUNDIV}
tar_target(FUNDIV_FrenchNFI_tree, 
           Format_trees_TreeMort_to_FUNDIV(TreeMort_tree, TreeMort_plot, FUNDIV_plot))
```

Lastly, we can replace the French data in the original FUNDIV tree dataset by the newly formatted `FUNDIV_FrenchNFI_tree`. 

```{targets replace-FrenchNFI-FUNDIV}
tar_target(FUNDIV_tree, 
           (FUNDIV_tree_original %>% 
             filter(country != "FR") %>% 
             rbind(FUNDIV_FrenchNFI_tree)))
```


### Import disturbance data

For each country, we create a dataset containing the dusturbance type ([Senf & Seidl, 2021a](https://doi.org/10.1111/gcb.15679)) and year ([Senf & Seidl, 2021b](https://www.nature.com/articles/s41893-020-00609-y)) for each plot (if any disturbance occured). Since the french coordinates are blured (500m), we include a larger buffer for french data. 

```{targets import-disturbance-Senf}
list(
  tar_target(FUNDIV_Plots_disturbance_belgium, 
             Get_disturbance_per_plot("belgium", 15, FUNDIV_tree,
                                      "data/Disturbance")), 
  tar_target(FUNDIV_Plots_disturbance_france, 
             Get_disturbance_per_plot("france", 15, FUNDIV_tree,
                                      "data/Disturbance")), 
  tar_target(FUNDIV_Plots_disturbance_germany, 
             Get_disturbance_per_plot("germany", 15, FUNDIV_tree,
                                      "data/Disturbance")), 
  tar_target(FUNDIV_Plots_disturbance_finland, 
             Get_disturbance_per_plot("finland", 15, FUNDIV_tree,
                                      "data/Disturbance")), 
  tar_target(FUNDIV_Plots_disturbance_sweden, 
             Get_disturbance_per_plot("sweden", 15, FUNDIV_tree,
                                      "data/Disturbance")), 
  tar_target(FUNDIV_Plots_disturbance_spain, 
             Get_disturbance_per_plot("spain", 50, FUNDIV_tree,
                                      "data/Disturbance"))
)
```

We merge these datasets to have disturbance data for all FUNDIV plots. 

```{targets merge-disturbance-plots}
tar_target(FUNDIV_Plots_disturbance, 
           rbind.data.frame(FUNDIV_Plots_disturbance_belgium,
                            FUNDIV_Plots_disturbance_france, 
                            FUNDIV_Plots_disturbance_germany, 
                            FUNDIV_Plots_disturbance_finland, 
                            FUNDIV_Plots_disturbance_sweden, 
                            FUNDIV_Plots_disturbance_spain))
```

```{targets Add-disturbance-to-FUNDIV-tree}
tar_target(FUNDIV_tree_withdisturbance, 
           merge(FUNDIV_tree, FUNDIV_Plots_disturbance, 
                 by = "plotcode", all.x = T, all.y = F))
```


### Data exploration

First, let's look at the survival rate per plot, depending on the type of disturbance. 

```{targets plot-survival-disturbance-FUNDIV}
tar_target(plotFUNDIV_survival_disturbance,
           Plot_survival_perdisturbance(FUNDIV_tree_withdisturbance))
```

```{r figSurvival, fig.height=5, fig.width=5, fig.align='center'}
tar_read(plotFUNDIV_survival_disturbance)
ggplot2::ggsave(tar_read(plotFUNDIV_survival_disturbance), 
       filename = "plots/plotFUNDIV_survival_disturbance.pdf", 
       height = 12, width = 12, unit = 'cm')  
```

We can also check the spatial repartition of the different types of disturbance.

```{targets map-FUNDIV-plots-per-disturbance}
tar_target(map_FUNDIVplots_disturbance, 
           Map_FUNDIVplots_perDisturbance2(FUNDIV_tree_withdisturbance))
```

```{r figDisturbanceMap, fig.height=8, fig.width=8, fig.align='center'}
tar_read(map_FUNDIVplots_disturbance)
ggplot2::ggsave(tar_read(map_FUNDIVplots_disturbance), 
       filename = "plots/map_FUNDIVplots_disturbance.jpg", 
       height = 19, width = 19, unit = 'cm', dpi = 600)  
```

In France, NFI agents also estimated whether a disturbance occured between the two surveys. The plot below compare disturbance occurences in France between the two surveys based on NFI field estiamtion, or Senf dataset. 

```{targets map-compare-disturbance-NFI-Senf}
tar_target(Map_NFI_Senf_disturbance_compared, 
           Map_compare_NFI_Senf_disturbance(FUNDIV_tree_withdisturbance, NFI_plot_remeasure))
```

```{r figDisturbanceCompared, fig.height=4, fig.width=10, fig.align='center'}
tar_read(Map_NFI_Senf_disturbance_compared)
ggplot2::ggsave(tar_read(Map_NFI_Senf_disturbance_compared), 
       filename = "plots/Map_NFI_Senf_disturbance_compared.jpg", 
       height = 8, width = 20, unit = 'cm', dpi = 600)  
```

# Pipeline

If you ran all the `{targets}` chunks in non-interactive mode, then your R scripts are set up to run the pipeline.

```{r, message=FALSE, results='hide'}
tar_make()
```

